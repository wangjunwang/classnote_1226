// entry/src/main/ets/utils/NotificationHelper.ets
import { reminderAgentManager } from '@kit.BackgroundTasksKit';

// æ¥å£å®šä¹‰
interface ReminderWithId {
  reminderId: number;
}

export class NotificationHelper {

  /**
   * 1. å¾…åŠè¿›åº¦æ±‡æŠ¥ (ä¿æŒä¸å˜)
   */
  static async updateDailySummary(finishedCount: number, totalCount: number) {
    const targetHour = 23;
    const targetMinute = 0;
    const titleBase = 'ä»Šæ—¥å¾…åŠæ€»ç»“';

    const now = new Date();
    if (now.getHours() >= targetHour && now.getMinutes() > 0) { return; }

    try {
      const activeReminders = await reminderAgentManager.getValidReminders();
      for (const r of activeReminders) {
        if (r.title && r.title.includes(titleBase)) {
          const target = r as Object as ReminderWithId;
          const oldId = target.reminderId;
          if (oldId !== undefined && oldId !== null) {
            await reminderAgentManager.cancelReminder(oldId);
          }
        }
      }

      let percent = 0;
      let progressBar = '';
      if (totalCount > 0) {
        percent = Math.round((finishedCount / totalCount) * 100);
        const totalBlocks = 10;
        const filled = Math.round((finishedCount / totalCount) * totalBlocks);
        const empty = totalBlocks - filled;
        progressBar = 'â”'.repeat(filled) + 'â”€'.repeat(empty);
      } else {
        progressBar = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
      }

      const reminder: reminderAgentManager.ReminderRequestAlarm = {
        reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_ALARM,
        hour: targetHour,
        minute: targetMinute,
        daysOfWeek: [],
        title: `${titleBase} (${percent}%)`,
        content: `${progressBar}\nå·²å®Œæˆ ${finishedCount}/${totalCount} ä¸ªä»»åŠ¡`,
        ringDuration: 0,
        snoozeTimes: 0,
        timeInterval: 0,
        actionButton: [
          { title: 'æŸ¥çœ‹', type: reminderAgentManager.ActionButtonType.ACTION_BUTTON_TYPE_CLOSE }
        ]
      };
      await reminderAgentManager.publishReminder(reminder);
    } catch (err) {
      console.error('å‘å¸ƒå¾…åŠæé†’å¤±è´¥:', JSON.stringify(err));
    }
  }

  /**
   * 2. è¯¾ç¨‹æé†’ (æ—¥å†æé†’)
   * ä¿®æ”¹åæ•ˆæœï¼š
   * æ ‡é¢˜ï¼šä¸Šè¯¾æé†’
   * å†…å®¹ï¼š
   * ä¸Šè¯¾æ—¶é—´ï¼š10:00
   * ä¸Šè¯¾ç­çº§ï¼šå…¨å‘˜
   */
  static async addCourseReminder(courseName: string, startTime: number): Promise<number> {
    const courseDate = new Date(startTime);
    // æé†’æ—¶é—´ï¼šå‰ä¸€å¤©æ™šä¸Š 22:00
    const remindTime = new Date(startTime);
    remindTime.setDate(remindTime.getDate() - 1);
    remindTime.setHours(22, 0, 0, 0);

    // å¦‚æœå½“å‰å·²ç»è¿‡äº†æé†’æ—¶é—´ï¼Œåˆ™ä¸è®¾ç½®
    if (remindTime.getTime() < Date.now()) {
      return -1;
    }

    // æ ¼å¼åŒ–æ—¶é—´ (ä¾‹å¦‚ "10:00")
    const timeStr = `${courseDate.getHours().toString().padStart(2, '0')}:${courseDate.getMinutes().toString().padStart(2, '0')}`;

    const reminder: reminderAgentManager.ReminderRequestCalendar = {
      reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_CALENDAR,
      dateTime: {
        year: remindTime.getFullYear(),
        month: remindTime.getMonth() + 1,
        day: remindTime.getDate(),
        hour: remindTime.getHours(),
        minute: remindTime.getMinutes(),
      },
      repeatMonths: [],
      repeatDays: [],

      title: 'ä¸Šè¯¾æé†’',

      // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ã€æ ¸å¿ƒä¿®æ”¹ã€‘ ğŸ‘‡ğŸ‘‡ğŸ‘‡
      // ä½¿ç”¨ \n æ¢è¡Œï¼Œä¿¡æ¯æ›´æ¸…æ™°
      content: `ä¸Šè¯¾æ—¶é—´ï¼š${timeStr}\nä¸Šè¯¾ç­çº§ï¼š${courseName}`,
      // ğŸ‘†ğŸ‘†ğŸ‘†

      ringDuration: 0,
      snoozeTimes: 0,
      timeInterval: 0,
      actionButton: [
        { title: 'çŸ¥é“äº†', type: reminderAgentManager.ActionButtonType.ACTION_BUTTON_TYPE_CLOSE }
      ]
    };

    try {
      const id = await reminderAgentManager.publishReminder(reminder);
      console.info(`è¯¾ç¨‹å‰å¤œæé†’è®¾ç½®æˆåŠŸ: ID ${id}`);
      return id;
    } catch (err) {
      console.error('è®¾ç½®è¯¾ç¨‹æé†’å¤±è´¥:', JSON.stringify(err));
      return -1;
    }
  }

  static async cancelReminder(reminderId: number) {
    if (reminderId < 0) return;
    try {
      await reminderAgentManager.cancelReminder(reminderId);
    } catch (err) {
      console.error('å–æ¶ˆæé†’å¤±è´¥:', JSON.stringify(err));
    }
  }
}
